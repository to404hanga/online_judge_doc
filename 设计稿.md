# OnlineJudge 设计稿

## 模块划分

| 模块名称                  | 功能描述                                   |
| ------------------------ | ---------------------------------------- |
| 前端模块                  | 负责用户交互，展示题目、提交代码、查看结果等功能 |
| 统一网关模块               | 负责接收前端请求并鉴权，路由到后端模块         |
| 后端 controller 模块      | 负责处理前端请求                            |
| 后端 judger-master 模块   | 负责接收并分配判题请求                       |
| 后端 judger-worker 模块   | 负责从队列获取判题任务并分发到具体的评测机执行   |
| 后端 judger-executor 模块 | 负责在评测机上执行代码编译与运行任务           |
| 后端 data-processor 模块  | 负责接收执行结果并写入数据库                  |

## 数据存储

### 题目数据

#### 题目元数据

存储与 mysql 中

#### 题面与测试用例

统一存储在 [cos](https://console.cloud.tencent.com/lighthouse/cos/index?rid=1) 中，[相关文档](https://cloud.tencent.com/document/product/1207/80964?from=console_document_search)，使用 [cos api](https://cloud.tencent.com/document/product/436/31215) 进行操作

分散缓存在评测机的本地文件系统中 ( 定期清理 + 提前预热 )

#### 用户数据

存储与 mysql 中

#### 比赛数据

存储与 mysql 中

#### 提交数据

存储与 mysql 中

## 表结构设计

### 题目表 problem

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 题目 id ( 自增主键 ) |
| title | string: varchar(255) | 题目标题 |
| url | string: varchar(255) | 题面 url (存储于 [轻量对象存储](https://console.cloud.tencent.com/lighthouse/cos/index?rid=1) ) |
| status | *int8: tinyint | 题目状态 ( 0: 未发布, 1: 已发布, 2: 已删除 ) |
| creator_id | string: varchar(50) | 创建者学号 |
| updater_id | string: varchar(50) | 更新者学号 |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |

### 用户表 user

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 用户 id ( 自增主键 ) |
| username | string: varchar(50) | 用户名 ( 学号 ) |
| realname | string: varchar(50) | 真实姓名 |
| password | string: varchar(255) | 密码 ( bcrypt ) |
| role | *int8: tinyint | 用户角色 ( 0: 普通用户, 1: 管理员 ) |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |

### 比赛表 competition

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 比赛 id ( 自增主键 ) |
| name | string: varchar(255) | 比赛名称 |
| start_time | time.Time: datetime | 比赛开始时间 |
| end_time | time.Time: datetime | 比赛结束时间 |
| status | *int8: tinyint | 比赛状态 ( 0: 未发布, 1: 已发布, 2: 已删除 ) |
| creator_id | string: varchar(50) | 创建者学号 |
| updater_id | string: varchar(50) | 更新者学号 |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |

### 比赛题目表 competition_problem

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 比赛题目 id ( 自增主键 ) |
| competition_id | uint64: bigint unsigned | 比赛 id |
| problem_id | uint64: bigint unsigned | 题目 id |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |

### 题目测试用例表 problem_testcase

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 测试用例 id ( 自增主键 ) |
| problem_id | uint64: bigint unsigned | 题目 id |
| input_url | string: varchar(255) | 输入用例 url ( 存储于 [轻量对象存储](https://console.cloud.tencent.com/lighthouse/cos/index?rid=1) ) |
| output_url | string: varchar(255) | 输出用例 url ( 存储于 [轻量对象存储](https://console.cloud.tencent.com/lighthouse/cos/index?rid=1) ) |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |

### 提交表 submission

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 提交 id ( 自增主键 ) |
| competition_id | uint64: bigint unsigned | 比赛 id |
| problem_id | uint64: bigint unsigned | 题目 id |
| user_id | uint64: bigint unsigned | 用户 id |
| code_url | string: varchar(255) | 提交代码 url ( 存储于 [轻量对象存储](https://console.cloud.tencent.com/lighthouse/cos/index?rid=1) ) |
| status | *int8: tinyint | 提交状态 ( 0: 待判题, 1: 判题中, 2: 已判题 ) |
| result | *int8: tinyint | 评测结果 ( 0: 未判题, 1:  Accepted, 2: Wrong Answer, 3: Compile Error, 4: Runtime Error, 5: Time Limit Exceeded, 6: Memory Limit Exceeded, 7: Output Limit Exceeded ) |
| time_used | int: int | 最大评测时间 ( 单位: 毫秒 ) |
| memory_used | int: int | 最大评测内存 ( 单位: KB ) |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |

### 评测表 evaluation

| 字段名 | 类型 | 描述 |
| --- | --- | --- |
| id | uint64: bigint unsigned | 评测 id ( 自增主键 ) |
| submission_id | uint64: bigint unsigned | 提交 id |
| time_used | int: int | 评测时间 ( 单位: 毫秒 ) |
| memory_used | int: int | 评测内存 ( 单位: KB ) |
| accepted | *int8: tinyint | 是否通过 ( 0: 未判题, 1: 已通过, 2: 未通过 ) |
| created_at | time.Time: datetime | 创建时间 |
| updated_at | time.Time: datetime | 更新时间 |
